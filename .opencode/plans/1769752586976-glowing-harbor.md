# Message Batching Implementation Plan

## Overview
Implement a message batching system using Convex scheduler to prevent the assistant from responding to each message individually when a user sends multiple messages in quick succession.

## Problem
Currently, when a user sends messages like:
- "Hey"
- "Do you have shoes?"
- "In size 10?"

The assistant responds 3 separate times. We want to wait ~4 seconds, collect all messages, and respond once with full context.

## Solution Architecture

### Core Flow
1. **Webhook receives message** → Don't process immediately
2. **Save message to `pending_messages` table**
3. **Cancel any existing scheduled job** for this thread
4. **Schedule new job** to run in 4 seconds using Convex scheduler
5. **When scheduled job fires** → Process all pending messages as one batch
6. **Send single AI response** addressing all messages together
7. **Clear pending messages** for this thread

### Data Model Changes

#### New Table: `pending_messages`
```typescript
pending_messages: defineTable({
  threadId: v.id("threads"),
  content: v.string(),
  timestamp: v.number(),
  platformMessageId: v.optional(v.string()),
  // Track order for proper concatenation
  sequenceNumber: v.number(),
})
  .index("by_thread", ["threadId"])
  .index("by_thread_sequence", ["threadId", "sequenceNumber"])
```

#### Modified Table: `threads` (add scheduling tracking)
```typescript
// Add fields to threads table:
scheduledJobId: v.optional(v.string()),  // Convex internal job ID
lastMessageAt: v.number(),  // Already exists, use for debounce window check
```

### Convex Functions

#### 1. `convex/pendingMessages.ts`
- `addPendingMessage` - mutation to add message to queue
- `getPendingMessages` - query to fetch all pending for thread (ordered by sequence)
- `clearPendingMessages` - mutation to remove all pending for thread after processing

#### 2. `convex/threads.ts` (enhance existing)
- `getScheduledJobId` - query to check if there's an active job
- `cancelScheduledJob` - action to cancel existing job via scheduler
- `scheduleProcessingJob` - action to schedule new processing job, returns jobId
- `updateScheduledJob` - mutation to store/clear jobId on thread

#### 3. `convex/scheduledActions.ts` (NEW)
- `processPendingMessages` - internal action triggered by scheduler
  - Fetches pending messages
  - Concatenates them with proper formatting ("Hey. Do you have shoes? In size 10?")
  - Calls existing AI assistant logic
  - Sends response
  - Clears pending queue

#### 4. `convex/scheduler.ts` (NEW - scheduler wrapper)
- `scheduleMessageProcessing` - wrapper around ctx.scheduler.runAfter()
- `cancelScheduledJob` - wrapper around ctx.scheduler.cancel()

### Webhook Handler Changes

#### Current Flow (Messenger Example):
```typescript
// 1. Receive message
// 2. Check duplicates
// 3. Sleep 5s
// 4. Show typing indicator  
// 5. Call generateShopifyReply (AI processing)
// 6. Send response
```

#### New Flow:
```typescript
// 1. Receive message
// 2. Check duplicates
// 3. Get threadId
// 4. Add message to pending_messages queue
// 5. Check for existing scheduled job
//   - If exists: cancel it
// 6. Schedule new job to run in 4 seconds
// 7. Update thread with new jobId
// 8. Return 200 immediately (no AI processing here!)
```

### Key Design Decisions

1. **Batch Window: 4 seconds**
   - Sweet spot between responsiveness and batching
   - User won't notice slight delay, but assistant gets full context

2. **Message Concatenation Strategy**
   - Join multiple messages with ". " or just space
   - Preserve original order using sequenceNumber
   - Example: "Hey" + "Do you have shoes?" + "In size 10?" → "Hey. Do you have shoes? In size 10?"

3. **Typing Indicator Timing**
   - Show typing indicator when scheduled job starts processing (not when message arrives)
   - This feels more natural - user sees "typing" just before response

4. **Error Handling**
   - If scheduling fails, fallback to immediate processing
   - If batch processing fails, log error and clear queue to prevent stuck state
   - Duplicate detection still happens at webhook level

5. **Edge Cases**
   - User sends 1 message → Wait 4s → Normal response ✓
   - User sends 5 rapid messages → All batched → One response ✓
   - User sends message at T=0, another at T=3.9s → Both batched (within 4s window) ✓
   - User sends message at T=0, another at T=4.1s → Two separate responses ✓

### Files to Modify

1. **convex/schema.ts**
   - Add `pending_messages` table
   - Add `scheduledJobId` to threads table

2. **convex/pendingMessages.ts** (NEW)
   - All pending message operations

3. **convex/scheduledActions.ts** (NEW)
   - Batch processing action

4. **convex/scheduler.ts** (NEW)
   - Scheduler wrapper functions

5. **convex/threads.ts**
   - Add scheduling state management helpers

6. **app/api/webhooks/messenger/route.ts**
   - Replace immediate processing with queue-based flow
   - Remove sleep + typing indicator from webhook

7. **app/api/webhooks/instagram/route.ts**
   - Same changes as messenger

### Migration Strategy

No migration needed - new tables start empty, threads without `scheduledJobId` just get scheduled as normal.

### Testing Plan

1. Send single message → Verify 4s delay then response
2. Send 3 messages within 2 seconds → Verify one response addressing all 3
3. Send message, wait 4.5s, send another → Verify two separate responses
4. Check that pending_messages table clears after processing
5. Verify typing indicator shows during actual AI processing
6. Test with both Messenger and Instagram webhooks

### Performance Considerations

- Index on `threadId` for fast pending message lookups
- Scheduler uses Convex's built-in job queue (reliable, distributed)
- No polling - purely event-driven
- Minimal overhead: one extra DB write per message, but fewer AI calls

## Implementation Order

1. Create schema changes (pending_messages table + thread fields)
2. Create pendingMessages.ts with CRUD operations
3. Create scheduler.ts with schedule/cancel functions
4. Create scheduledActions.ts with batch processing logic
5. Add scheduling helpers to threads.ts
6. Update Messenger webhook handler
7. Update Instagram webhook handler
8. Test end-to-end

## Verification Steps

1. Deploy changes
2. Send rapid messages to test bot
3. Check Convex dashboard:
   - pending_messages table should briefly show messages
   - Messages should disappear after processing
   - Scheduler logs should show jobs being cancelled and rescheduled
4. Verify responses are batched correctly
5. Check that single messages still work normally
